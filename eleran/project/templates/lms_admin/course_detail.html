{% extends 'base.html' %}

{% block title %}{{ course.title }} - Admin{% endblock %}

{% block content %}
<div class="admin-container">
    <nav class="admin-nav">
        <div class="nav-header">
            <h2><i class="fas fa-graduation-cap"></i> LMS Admin</h2>
        </div>
        <ul class="nav-menu">
            <li><a href="{% url 'lms_admin:dashboard' %}"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
            <li><a href="{% url 'lms_admin:logout' %}"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
    </nav>

    <div class="admin-main">
        <div class="admin-header">
            <h1>{{ course.title }}</h1>
            <button class="btn-primary" onclick="openAddModuleModal()">
                <i class="fas fa-plus"></i> Add Module
            </button>
        </div>

        <div class="course-info">
            <p>{{ course.description }}</p>
            <div class="course-meta">
                <span><strong>Price:</strong> ${{ course.price }}</span>
                <span><strong>Status:</strong> {% if course.is_published %}Published{% else %}Draft{% endif %}</span>
            </div>
        </div>

        <div class="modules-section">
            <h2>Modules</h2>
            {% for module in modules %}
            <div class="module-card">
                <div class="module-header">
                    <h3><i class="fas fa-folder"></i> {{ module.title }}</h3>
                    <button class="btn-small" onclick="openAddLessonModal({{ module.id }})">
                        <i class="fas fa-plus"></i> Add Lesson
                    </button>
                </div>
                <p>{{ module.description }}</p>
                <div class="lessons-list">
                    {% for lesson in module.lessons.all %}
                    <div class="lesson-item">
                        <div class="lesson-info">
                            <i class="fas fa-{% if lesson.lesson_type == 'video' %}video{% elif lesson.lesson_type == 'text' %}file-alt{% else %}file-download{% endif %}"></i>
                            <span>{{ lesson.title }}</span>
                            <span class="lesson-type">{{ lesson.get_lesson_type_display }}</span>
                        </div>
                        <div class="lesson-actions">
                            <button class="btn-icon btn-edit-lesson" onclick="openEditLessonModal({{ lesson.id }}, '{{ lesson.title|escapejs }}', '{{ lesson.lesson_type }}', '{{ lesson.content|escapejs }}', '{{ lesson.video_url }}', {{ lesson.order }})" title="Edit Lesson">
                                <i class="fas fa-edit"></i>
                            </button>
                            <a href="{% url 'lms_admin:delete_lesson' lesson.id %}" class="btn-icon btn-delete-lesson" onclick="return confirm('Are you sure you want to delete this lesson?')" title="Delete Lesson">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                    </div>
                    {% empty %}
                    <p class="no-lessons">No lessons yet.</p>
                    {% endfor %}
                </div>
            </div>
            {% empty %}
            <p class="no-modules">No modules yet. Click "Add Module" to create one.</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Add Module Modal -->
<div id="addModuleModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAddModuleModal()">&times;</span>
        <h2><i class="fas fa-folder-plus"></i> Add Module</h2>
        <form id="addModuleForm" method="post" action="{% url 'lms_admin:add_module' course.id %}">
            {% csrf_token %}
            <div class="form-group">
                <label for="module_title">Module Title *</label>
                <input type="text" id="module_title" name="title" required>
            </div>
            <div class="form-group">
                <label for="module_description">Description</label>
                <textarea id="module_description" name="description" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="module_order">Order</label>
                <input type="number" id="module_order" name="order" value="0">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="closeAddModuleModal()">Cancel</button>
                <button type="submit" class="btn-primary"><i class="fas fa-save"></i> Add Module</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Lesson Modal -->
<div id="addLessonModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAddLessonModal()">&times;</span>
        <h2><i class="fas fa-file-medical"></i> Add Lesson</h2>
        <form id="addLessonForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group">
                <label for="lesson_title">Lesson Title *</label>
                <input type="text" id="lesson_title" name="title" required>
            </div>
            <div class="form-group">
                <label for="lesson_type">Lesson Type *</label>
                <select id="lesson_type" name="lesson_type" required onchange="handleLessonTypeChange()">
                    <option value="text">Text/Content</option>
                    <option value="video">Video</option>
                    <option value="resource">Resource/PDF</option>
                </select>
            </div>
            <div class="form-group" id="content_group">
                <label for="lesson_content">Content</label>
                <textarea id="lesson_content" name="content" rows="4"></textarea>
            </div>
            <div class="form-group" id="video_url_group" style="display:none;">
                <label for="video_url">YouTube URL</label>
                <input type="url" id="video_url" name="video_url" placeholder="https://www.youtube.com/watch?v=...">
            </div>
            <div class="form-group" id="video_file_group" style="display:none;">
                <label for="video_file">OR Upload Video (MP4)</label>
                <input type="file" id="video_file" name="video_file" accept="video/mp4">
            </div>
            <div class="form-group" id="resource_file_group" style="display:none;">
                <label for="resource_file">Upload Resource (PDF)</label>
                <input type="file" id="resource_file" name="resource_file" accept=".pdf">
            </div>
            <div class="form-group">
                <label for="lesson_order">Order</label>
                <input type="number" id="lesson_order" name="order" value="0">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="closeAddLessonModal()">Cancel</button>
                <button type="submit" class="btn-primary"><i class="fas fa-save"></i> Add Lesson</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Lesson Modal -->
<div id="editLessonModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditLessonModal()">&times;</span>
        <h2><i class="fas fa-edit"></i> Edit Lesson</h2>
        <form id="editLessonForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" id="edit_lesson_id" name="lesson_id">
            <div class="form-group">
                <label for="edit_lesson_title">Lesson Title *</label>
                <input type="text" id="edit_lesson_title" name="title" required>
            </div>
            <div class="form-group">
                <label for="edit_lesson_type">Lesson Type *</label>
                <select id="edit_lesson_type" name="lesson_type" required onchange="handleEditLessonTypeChange()">
                    <option value="text">Text/Content</option>
                    <option value="video">Video</option>
                    <option value="resource">Resource/PDF</option>
                </select>
            </div>
            <div class="form-group" id="edit_content_group">
                <label for="edit_lesson_content">Content</label>
                <textarea id="edit_lesson_content" name="content" rows="4"></textarea>
            </div>
            <div class="form-group" id="edit_video_url_group" style="display:none;">
                <label for="edit_video_url">YouTube URL</label>
                <input type="url" id="edit_video_url" name="video_url" placeholder="https://www.youtube.com/watch?v=...">
            </div>
            <div class="form-group" id="edit_video_file_group" style="display:none;">
                <label for="edit_video_file">OR Upload New Video (MP4)</label>
                <input type="file" id="edit_video_file" name="video_file" accept="video/mp4">
                <small>Leave empty to keep current video</small>
            </div>
            <div class="form-group" id="edit_resource_file_group" style="display:none;">
                <label for="edit_resource_file">Upload New Resource (PDF)</label>
                <input type="file" id="edit_resource_file" name="resource_file" accept=".pdf">
                <small>Leave empty to keep current resource</small>
            </div>
            <div class="form-group">
                <label for="edit_lesson_order">Order</label>
                <input type="number" id="edit_lesson_order" name="order" value="0">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="closeEditLessonModal()">Cancel</button>
                <button type="submit" class="btn-primary"><i class="fas fa-save"></i> Update Lesson</button>
            </div>
        </form>
    </div>
</div>

<script>
let currentModuleId = null;
let currentLessonId = null;

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function openAddModuleModal() {
    document.getElementById('addModuleModal').style.display = 'block';
}

function closeAddModuleModal() {
    document.getElementById('addModuleModal').style.display = 'none';
}

function openAddLessonModal(moduleId) {
    currentModuleId = moduleId;
    document.getElementById('addLessonModal').style.display = 'block';
}

function closeAddLessonModal() {
    document.getElementById('addLessonModal').style.display = 'none';
}

function openEditLessonModal(lessonId, title, lessonType, content, videoUrl, order) {
    currentLessonId = lessonId;
    document.getElementById('edit_lesson_id').value = lessonId;
    document.getElementById('edit_lesson_title').value = title;
    document.getElementById('edit_lesson_type').value = lessonType;
    document.getElementById('edit_lesson_content').value = content;
    document.getElementById('edit_video_url').value = videoUrl;
    document.getElementById('edit_lesson_order').value = order;
    
    handleEditLessonTypeChange();
    document.getElementById('editLessonModal').style.display = 'block';
}

function closeEditLessonModal() {
    document.getElementById('editLessonModal').style.display = 'none';
}

function handleLessonTypeChange() {
    const lessonType = document.getElementById('lesson_type').value;
    document.getElementById('content_group').style.display = lessonType === 'text' ? 'block' : 'none';
    document.getElementById('video_url_group').style.display = lessonType === 'video' ? 'block' : 'none';
    document.getElementById('video_file_group').style.display = lessonType === 'video' ? 'block' : 'none';
    document.getElementById('resource_file_group').style.display = lessonType === 'resource' ? 'block' : 'none';
}

function handleEditLessonTypeChange() {
    const lessonType = document.getElementById('edit_lesson_type').value;
    document.getElementById('edit_content_group').style.display = lessonType === 'text' ? 'block' : 'none';
    document.getElementById('edit_video_url_group').style.display = lessonType === 'video' ? 'block' : 'none';
    document.getElementById('edit_video_file_group').style.display = lessonType === 'video' ? 'block' : 'none';
    document.getElementById('edit_resource_file_group').style.display = lessonType === 'resource' ? 'block' : 'none';
}

// Handle module form submission
document.getElementById('addModuleForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const csrftoken = getCookie('csrftoken');
    
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error adding module. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding module. Please check the console for details.');
    });
});

// Handle lesson form submission
document.getElementById('addLessonForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const url = `/lms-admin/module/${currentModuleId}/add-lesson/`;
    const csrftoken = getCookie('csrftoken');
    
    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error adding lesson. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding lesson. Please check the console for details.');
    });
});

// Handle edit lesson form submission
document.getElementById('editLessonForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const url = `/lms-admin/lesson/${currentLessonId}/edit/`;
    const csrftoken = getCookie('csrftoken');
    
    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error updating lesson. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating lesson. Please check the console for details.');
    });
});
</script>

{% block extra_css %}
<style>
.lesson-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #eee;
}

.lesson-item:last-child {
    border-bottom: none;
}

.lesson-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
}

.lesson-info i {
    color: #667eea;
}

.lesson-type {
    color: #6c757d;
    font-size: 0.875rem;
    font-style: italic;
}

.lesson-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-icon {
    background: none;
    border: none;
    padding: 0.5rem;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.3s;
    color: #6c757d;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.btn-icon:hover {
    background: #f8f9fa;
}

.btn-edit-lesson {
    color: #667eea;
}

.btn-edit-lesson:hover {
    background: #e3f2fd;
    color: #1976d2;
}

.btn-delete-lesson {
    color: #dc3545;
    text-decoration: none;
}

.btn-delete-lesson:hover {
    background: #f8d7da;
    color: #a71d2a;
}

small {
    display: block;
    color: #6c757d;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}
</style>
{% endblock %}
{% endblock %}
