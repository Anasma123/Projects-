<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add New Product</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root {
        --bg: #f0f4fb;
        --card: #fff;
        --radius: 12px;
        --shadow: 0 20px 40px -10px rgba(55, 63, 104, 0.2);
        --primary: #5c5ce5;
        --muted: #6f7a92;
        --radius-sm: 8px;
    }
    * { box-sizing:border-box; }
    body {
        font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
        background: linear-gradient(135deg,#5c5ce5 0%,#8a94f7 100%);
        margin:0;
        padding:0;
        min-height:100vh;
        color:#1f2d3a;
    }
    .page {
        max-width: 1120px;
        margin: 0 auto;
        padding: 30px 20px;
    }
    .header {
        display:flex;
        justify-content: space-between;
        align-items:center;
        gap:10px;
        flex-wrap: wrap;
        margin-bottom: 25px;
    }
    .title {
        display:flex;
        align-items:center;
        gap:10px;
        font-size: 1.5rem;
        font-weight: 600;
        color: #fff;
    }
    .back-btn {
        background: #fff;
        color: #5c5ce5;
        padding: 10px 18px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        display:inline-flex;
        align-items:center;
        gap:6px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    }
    .card {
        background: #f5f7fc;
        border-radius: var(--radius);
        padding: 30px;
        position: relative;
        overflow: hidden;
    }
    .form-grid {
        display: grid;
        gap: 20px;
        grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
        margin-bottom: 30px;
    }
    .field {
        display:flex;
        flex-direction: column;
        gap:6px;
    }
    .field label {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom:4px;
    }
    .select, .input {
        padding: 14px 16px;
        border-radius: 12px;
        border: none;
        outline: none;
        font-size: 1rem;
        background: #eef2f9;
        width: 100%;
    }
    .input[readonly] {
        background: #dfe3ed;
        cursor: not-allowed;
    }
    .small-muted {
        font-size: 0.75rem;
        color: #888;
        margin-top: 4px;
    }
    .btn-primary {
        background: #fff;
        color: var(--primary);
        padding: 14px 24px;
        border-radius: 10px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        box-shadow: 0 16px 32px -4px rgba(92,92,229,0.35);
        transition: all .2s ease;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 40px -4px rgba(92,92,229,0.45);
    }
    .preview {
        margin-top: 10px;
        padding: 25px;
        background: linear-gradient(135deg,#eef2fb 0%,#f7f4ff 100%);
        border-radius: var(--radius);
        display: grid;
        grid-template-columns: repeat(auto-fit,minmax(140px,1fr));
        gap: 18px;
    }
    .preview-card {
        background: white;
        padding: 18px 16px;
        border-radius: var(--radius-sm);
        box-shadow: 0 12px 28px rgba(55,63,104,0.06);
        display:flex;
        flex-direction: column;
        gap:6px;
    }
    .preview-card .label {
        font-size: 0.6rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 700;
        color: #888;
    }
    .preview-card .value {
        font-size: 1.1rem;
        font-weight: 600;
        margin-top:4px;
    }
    .error {
        background: #ffe3e3;
        padding: 10px 14px;
        border-radius: 8px;
        color: #b00020;
        margin-bottom: 12px;
        font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="header">
        <div class="title">➕ Add New Product</div>
        <a href="{% url 'list_products' %}" class="back-btn">← Back to Products</a>
    </div>

    <div class="card">
        {% if messages %}
            {% for msg in messages %}
                <div class="error">{{ msg }}</div>
            {% endfor %}
        {% endif %}

        <form method="POST" id="productForm">
            {% csrf_token %}
            <div class="form-grid">
                <div class="field">
                    <label for="category">Category</label>
                    <select name="category" id="category" class="select" required>
                        <option value="">Select category</option>
                        {% for c in categories %}
                            <option value="{{ c.id }}">{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="field">
                    <label for="subcategory">Subcategory</label>
                    <select name="subcategory" id="subcategory" class="select" required disabled>
                        <option value="">Select subcategory</option>
                    </select>
                </div>

                <div class="field">
                    <label for="existing_product">Existing Product</label>
                    <select name="existing_product" id="existing_product" class="select" disabled>
                        <option value="">Error loading products</option>
                    </select>
                    <div class="small-muted">Or enter a new product name below</div>
                </div>

                <div class="field">
                    <label for="new_name">New Product Name</label>
                    <input type="text" name="new_name" id="new_name" class="input" placeholder="Enter new product name">
                </div>

                <div class="field">
                    <label>MRP (₹)</label>
                    <input type="text" readonly id="mrp" class="input" value="0.00">
                </div>

                <div class="field">
                    <label>Purchase Rate (₹)</label>
                    <input type="text" readonly id="purchase_rate" class="input" value="0.00">
                </div>

                <div class="field">
                    <label>Stock Quantity</label>
                    <input type="text" readonly id="stock_quantity" class="input" value="0">
                </div>

                <div class="field">
                    <label for="selling_price">Selling Price (₹)</label>
                    <input type="number" step="0.01" name="selling_price" id="selling_price" class="input" value="0.00" required>
                </div>
            </div>

            <div style="display:flex; justify-content:flex-end; gap:12px; flex-wrap:wrap; margin-top:10px;">
                <button type="submit" class="btn-primary">Save Product</button>
            </div>
        </form>

        <div class="preview" aria-label="preview data">
            <div class="preview-card">
                <div class="label">Product</div>
                <div class="value" id="preview_name">—</div>
            </div>
            <div class="preview-card">
                <div class="label">Category</div>
                <div class="value" id="preview_category">—</div>
            </div>
            <div class="preview-card">
                <div class="label">Subcategory</div>
                <div class="value" id="preview_subcategory">—</div>
            </div>
            <div class="preview-card">
                <div class="label">MRP</div>
                <div class="value" id="preview_mrp">₹0.00</div>
            </div>
            <div class="preview-card">
                <div class="label">Purchase Rate</div>
                <div class="value" id="preview_purchase_rate">₹0.00</div>
            </div>
            <div class="preview-card">
                <div class="label">Stock</div>
                <div class="value" id="preview_stock">0</div>
            </div>
            <div class="preview-card">
                <div class="label">Selling Price</div>
                <div class="value" id="preview_selling_price">₹0.00</div>
            </div>
        </div>
    </div>
  </div>

  <script>
    const categoryEl = document.getElementById('category');
    const subcategoryEl = document.getElementById('subcategory');
    const existingProductEl = document.getElementById('existing_product');

    function fetchSubcategories(category_id) {
        subcategoryEl.innerHTML = '<option value="">Loading...</option>';
        subcategoryEl.disabled = true;
        fetch(`/add-product/ajax/load-subcategories/?category_id=${category_id}`)
            .then(r => r.json())
            .then(data => {
                subcategoryEl.innerHTML = '<option value="">Select subcategory</option>';
                data.forEach(s => {
                    const o = document.createElement('option');
                    o.value = s.id;
                    o.textContent = s.name;
                    subcategoryEl.appendChild(o);
                });
                subcategoryEl.disabled = false;
            })
            .catch(() => {
                subcategoryEl.innerHTML = '<option value="">Error</option>';
            });
    }

    function fetchProducts(subcategory_id) {
        existingProductEl.innerHTML = '<option value="">Loading...</option>';
        existingProductEl.disabled = true;
        fetch(`/add-product/ajax/load-products/?subcategory_id=${subcategory_id}`)
            .then(r => r.json())
            .then(data => {
                existingProductEl.innerHTML = '<option value="">Select existing product</option>';
                data.forEach(p => {
                    const o = document.createElement('option');
                    o.value = p.id;
                    o.textContent = p.name;
                    existingProductEl.appendChild(o);
                });
                existingProductEl.disabled = false;
            })
            .catch(() => {
                existingProductEl.innerHTML = '<option value="">Error loading products</option>';
                existingProductEl.disabled = true;
            });
    }

    function loadProductDetails(product_id) {
        if (!product_id) return;
        fetch(`/add-product/ajax/get-product-details/?product_id=${product_id}`)
            .then(r => r.json())
            .then(d => {
                document.getElementById('preview_name').textContent = d.name;
                document.getElementById('preview_category').textContent = d.category;
                document.getElementById('preview_subcategory').textContent = d.subcategory;
                document.getElementById('preview_mrp').textContent = `₹${parseFloat(d.mrp).toFixed(2)}`;
                document.getElementById('preview_purchase_rate').textContent = `₹${parseFloat(d.purchase_rate).toFixed(2)}`;
                document.getElementById('preview_stock').textContent = d.stock_quantity;
                document.getElementById('preview_selling_price').textContent = `₹${parseFloat(d.selling_price).toFixed(2)}`;
                document.getElementById('mrp').value = parseFloat(d.mrp).toFixed(2);
                document.getElementById('purchase_rate').value = parseFloat(d.purchase_rate).toFixed(2);
                document.getElementById('stock_quantity').value = d.stock_quantity;
                document.getElementById('sale_rate').value = parseFloat(d.selling_price).toFixed(2);
            })
            .catch(() => {
                // silently ignore
            });
    }

    categoryEl.addEventListener('change', e => {
        const cat = e.target.value;
        if (cat) {
            fetchSubcategories(cat);
        } else {
            subcategoryEl.innerHTML = '<option value="">Select subcategory</option>';
            subcategoryEl.disabled = true;
            existingProductEl.innerHTML = '<option value="">Error loading products</option>';
            existingProductEl.disabled = true;
        }
        // clear preview/new name
        document.getElementById('preview_name').textContent = '—';
    });

    subcategoryEl.addEventListener('change', e => {
        const sub = e.target.value;
        if (sub) {
            fetchProducts(sub);
        } else {
            existingProductEl.innerHTML = '<option value="">Select existing product</option>';
            existingProductEl.disabled = true;
        }
        document.getElementById('preview_name').textContent = '—';
    });

    existingProductEl.addEventListener('change', e => {
        const pid = e.target.value;
        if (pid) {
            loadProductDetails(pid);
            document.getElementById('new_name').value = '';
        }
    });

    // if user types new name, clear existing product selection & preview
    document.getElementById('new_name').addEventListener('input', e => {
        existingProductEl.value = '';
        document.getElementById('preview_name').textContent = e.target.value || '—';
        document.getElementById('preview_selling_price').textContent = `₹${parseFloat(document.getElementById('selling_price').value||0).toFixed(2)}`;
    });

    // sync selling price preview
    document.getElementById('selling_price').addEventListener('input', e => {
        document.getElementById('preview_selling_price').textContent = `₹${parseFloat(e.target.value||0).toFixed(2)}`;
    });

    // initial disable
    subcategoryEl.disabled = true;
    existingProductEl.disabled = true;
  </script>
</body>
</html>
