<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Create New Invoice</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #2b6cb0;
      --secondary-color: #4299e1;
      --accent-color: #ebf4ff;
      --text-color: #2d3748;
      --border-color: #e2e8f0;
      --success-color: #48bb78;
      --light-gray: #f8fafc;
      --medium-gray: #e2e8f0;
    }
    
    body {
      background-color: #f7fafc;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--text-color);
      line-height: 1.6;
    }
    
    .invoice-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      padding: 2.5rem;
      margin: 2rem auto;
      max-width: 1400px;
    }
    
    .invoice-header {
      border-bottom: 2px solid var(--medium-gray);
      padding-bottom: 1.5rem;
      margin-bottom: 2.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .invoice-title {
      color: var(--primary-color);
      font-weight: 700;
      font-size: 1.75rem;
      margin: 0;
    }
    
    .section-title {
      color: var(--primary-color);
      font-weight: 600;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--medium-gray);
      position: relative;
    }
    
    .section-title:after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 60px;
      height: 2px;
      background-color: var(--secondary-color);
    }
    
    .summary-card {
      background-color: var(--light-gray);
      border-radius: 8px;
      padding: 1.75rem;
      border: 1px solid var(--medium-gray);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
    }
    
    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px dashed var(--medium-gray);
    }
    
    .summary-total {
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--primary-color);
      border-bottom: none;
      margin-top: 1.25rem;
      padding-top: 1.25rem;
      border-top: 2px solid var(--medium-gray);
    }
    
    .product-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-bottom: 1.5rem;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    .product-table th {
      background-color: var(--primary-color);
      color: white;
      padding: 1rem 0.8rem;
      text-align: left;
      font-weight: 600;
      border: none;
    }
    
    .product-table td {
      padding: 1rem 0.8rem;
      border-bottom: 1px solid var(--medium-gray);
      vertical-align: middle;
      position: relative;
      background-color: white;
    }
    
    .product-table tr:last-child td {
      border-bottom: none;
    }
    
    .btn-add {
      background-color: var(--success-color);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(72, 187, 120, 0.2);
    }
    
    .btn-add:hover {
      background-color: #38a169;
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(72, 187, 120, 0.3);
    }
    
    .btn-remove {
      color: #e53e3e;
      background: none;
      border: none;
      font-size: 1.2rem;
      transition: all 0.2s;
      opacity: 0.7;
    }
    
    .btn-remove:hover {
      color: #c53030;
      transform: scale(1.1);
      opacity: 1;
    }
    
    .form-control, .form-select {
      border-radius: 6px;
      padding: 0.6rem 0.75rem;
      border: 1px solid var(--medium-gray);
      transition: all 0.2s;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
    }
    
    .form-label {
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #4a5568;
    }
    
    .spinner {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      display: none;
    }
    
    .is-loading .spinner {
      display: block;
    }
    
    .is-loading .form-select {
      padding-right: 2.5rem;
    }
    
    .modal-table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .modal-table th, .modal-table td {
      border: 1px solid var(--medium-gray);
      padding: 0.75rem;
      text-align: left;
    }
    
    .modal-table th {
      background-color: var(--accent-color);
      font-weight: 600;
    }
    
    .alert {
      border-radius: 8px;
      padding: 1rem 1.25rem;
      border: none;
    }
    
    .alert-info {
      background-color: #ebf8ff;
      color: #2c5282;
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }
    
    .btn-primary:hover {
      background-color: #2c5282;
      border-color: #2c5282;
    }
    
    .btn-success {
      background-color: var(--success-color);
      border-color: var(--success-color);
      padding: 0.75rem 1.5rem;
      font-weight: 600;
    }
    
    .btn-success:hover {
      background-color: #38a169;
      border-color: #38a169;
    }
    
    .btn-outline-secondary {
      border-radius: 6px;
      padding: 0.75rem 1.5rem;
    }
    
    @media (max-width: 992px) {
      .invoice-container {
        padding: 1.5rem;
        margin: 1rem;
      }
      
      .product-table {
        display: block;
        overflow-x: auto;
      }
      
      .invoice-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .invoice-header .d-flex {
        margin-top: 1rem;
        align-self: flex-end;
      }
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="invoice-container">
      <div class="invoice-header">
        <h1 class="invoice-title"><i class="fas fa-file-invoice me-2"></i>Create New Invoice</h1>
        <div class="d-flex">
          <button type="button" class="btn btn-light" id="printBtn"><i class="fas fa-print me-1"></i> Preview</button>
        </div>
      </div>
      
      <div class="invoice-body">
        <form id="invoiceForm" method="POST" action="{% url 'add_billing' %}">
          {% csrf_token %}
          <input type="hidden" name="items-TOTAL_FORMS" id="items-TOTAL_FORMS" value="1">
          <input type="hidden" name="items-INITIAL_FORMS" value="0">
          <input type="hidden" name="items-MIN_NUM_FORMS" value="1">
          <input type="hidden" name="items-MAX_NUM_FORMS" value="1000">
          
          <!-- Customer Information -->
          <div class="row mb-5">
            <div class="col-md-6">
              <h4 class="section-title">Customer Information</h4>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Bill Number</label>
                  <input type="text" class="form-control" name="bill_number" value="Auto-generated" readonly>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Date</label>
                  <input type="date" class="form-control" name="date" value="{% now 'Y-m-d' %}">
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Customer Name *</label>
                <input type="text" class="form-control" name="customer_name" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Phone Number *</label>
                <input type="tel" class="form-control" name="customer_phone" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Address</label>
                <textarea class="form-control" name="customer_address" rows="2"></textarea>
              </div>
            </div>
            
            <div class="col-md-6">
              <h4 class="section-title">Invoice Summary</h4>
              <div class="summary-card">
                <div class="summary-item">
                  <span>Subtotal:</span>
                  <span id="subtotalValue">₹0.00</span>
                </div>
                <div class="summary-item">
                  <div class="d-flex align-items-center">
                    <span>Discount</span>
                    <input type="number" class="form-control form-control-sm ms-2" name="discount_amount" id="discountAmount" value="0" style="width: 90px;" min="0" step="0.01">
                  </div>
                  <span id="discountValue">-₹0.00</span>
                </div>
                
                <div class="summary-item summary-total">
                  <span>Grand Total:</span>
                  <span id="grandTotal">₹0.00</span>
                </div>
              </div>
              
              <div class="d-grid gap-2 mt-4">
                <button type="button" class="btn btn-success btn-lg" id="createInvoiceBtn"><i class="fas fa-check-circle me-2"></i>Create Invoice</button>
              </div>
            </div>
          </div>
          
          <!-- Products Section -->
          <h4 class="section-title">Products & Services</h4>
          <div class="alert alert-info d-flex align-items-center" role="alert" id="errorAlert" style="display: none;">
            <i class="fas fa-exclamation-circle me-2"></i>
            <div id="errorMessage"></div>
          </div>
          <div class="alert alert-info d-flex align-items-center" role="alert">
            <i class="fas fa-info-circle me-2"></i>
            <div>Select products from your inventory. The available stock will be automatically checked when you select a product.</div>
          </div>
          
          <div class="table-responsive">
            <table class="product-table">
              <thead>
                <tr>
                  <th width="25%">Category</th>
                  <th width="25%">Subcategory</th>
                  <th width="25%">Product</th>
                  <th width="10%">Stock</th>
                  <th width="10%">Qty</th>
                  <th width="15%">Rate (₹)</th>
                  <th width="15%">Total (₹)</th>
                  <th width="5%"></th>
                </tr>
              </thead>
              <tbody id="productRows">
                <tr data-index="0">
                  <td>
                    <select class="form-select form-select-sm category-select" name="items-0-category">
                      <option value="">Select Category</option>
                      {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                      {% endfor %}
                    </select>
                    <span class="spinner-border spinner-border-sm spinner" role="status"></span>
                  </td>
                  <td>
                    <select class="form-select form-select-sm subcategory-select" name="items-0-subcategory" disabled>
                      <option value="">Select Subcategory</option>
                    </select>
                    <span class="spinner-border spinner-border-sm spinner" role="status"></span>
                  </td>
                  <td>
                    <select class="form-select form-select-sm product-select" name="items-0-product" disabled>
                      <option value="">Select Product</option>
                    </select>
                    <span class="spinner-border spinner-border-sm spinner" role="status"></span>
                  </td>
                  <td>
                    <input type="text" class="form-control form-control-sm stock-input" readonly value="0">
                  </td>
                  <td>
                    <input type="number" class="form-control form-control-sm qty-input" name="items-0-quantity" min="1" value="1">
                  </td>
                  <td>
                    <input type="text" class="form-control form-control-sm rate-input" name="items-0-price" readonly>
                  </td>
                  <td>
                    <input type="text" class="form-control form-control-sm total-input" readonly value="0.00">
                  </td>
                  <td class="text-center">
                    <button type="button" class="btn btn-remove">
                      <i class="fas fa-times-circle"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="d-flex justify-content-between align-items-center mt-4">
            <button type="button" class="btn btn-add" id="addRowBtn">
              <i class="fas fa-plus me-2"></i>Add Another Product
            </button>
            <button type="button" class="btn btn-outline-secondary" id="cancelBtn">
              <i class="fas fa-times me-2"></i>Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Invoice Confirmation Modal -->
  <div class="modal fade" id="invoiceModal" tabindex="-1" aria-labelledby="invoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="invoiceModalLabel">Invoice Created</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <h6>Invoice Details</h6>
          <p><strong>Bill Number:</strong> <span id="modalBillNumber"></span></p>
          <p><strong>Customer Name:</strong> <span id="modalCustomerName"></span></p>
          <p><strong>Phone:</strong> <span id="modalCustomerPhone"></span></p>
          <p><strong>Address:</strong> <span id="modalCustomerAddress"></span></p>
          <table class="modal-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Rate (₹)</th>
                <th>Total (₹)</th>
              </tr>
            </thead>
            <tbody id="modalProductRows"></tbody>
          </table>
          <div class="mt-3">
            <p><strong>Subtotal:</strong> <span id="modalSubtotal"></span></p>
            <p><strong>Discount:</strong> <span id="modalDiscount"></span></p>
            <p><strong>Grand Total:</strong> <span id="modalGrandTotal"></span></p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary no-print" id="printInvoiceBtn"><i class="fas fa-print me-2"></i>Print & Save</button>
          <button type="button" class="btn btn-secondary no-print" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      let redirectUrl = ''; // Store redirect URL globally

      // Get CSRF token
      function getCsrfToken() {
        const token = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
        if (!token) {
          console.error('CSRF token not found');
          showError('CSRF token missing. Please refresh the page.');
        }
        return token;
      }

      // Show error alert
      function showError(message) {
        const alert = document.getElementById('errorAlert');
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.textContent = message;
        alert.style.display = 'flex';
        setTimeout(hideError, 5000); // Auto-hide after 5 seconds
      }

      // Hide error alert
      function hideError() {
        const alert = document.getElementById('errorAlert');
        alert.style.display = 'none';
      }

      // Fetch subcategories dynamically
      function loadSubcategories(row, categoryId) {
        const subcategorySelect = row.querySelector('.subcategory-select');
        subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
        subcategorySelect.disabled = true;
        subcategorySelect.parentElement.classList.add('is-loading');

        fetch(`/ajax/load-subcategories/?category_id=${categoryId}`, {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => {
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          return response.json();
        })
        .then(data => {
          if (data.error) {
            showError(data.error);
            return;
          }
          subcategorySelect.disabled = false;
          data.forEach(subcat => {
            const option = document.createElement('option');
            option.value = subcat.id;
            option.textContent = subcat.name;
            subcategorySelect.appendChild(option);
          });
        })
        .catch(error => {
          console.error('Error fetching subcategories:', error);
          showError(`Failed to load subcategories: ${error.message}`);
        })
        .finally(() => {
          subcategorySelect.parentElement.classList.remove('is-loading');
        });
      }

      // Fetch products dynamically
      function loadProducts(row, subcategoryId) {
        const productSelect = row.querySelector('.product-select');
        productSelect.innerHTML = '<option value="">Select Product</option>';
        productSelect.disabled = true;
        productSelect.parentElement.classList.add('is-loading');

        fetch(`/ajax/load-products/?subcategory_id=${subcategoryId}`, {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => {
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          return response.json();
        })
        .then(data => {
          if (data.error) {
            showError(data.error);
            return;
          }
          productSelect.disabled = false;
          data.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = product.product_name;
            option.setAttribute('data-stock', product.quantity || 0);
            option.setAttribute('data-rate', product.sale_rate || 0);
            productSelect.appendChild(option);
          });
        })
        .catch(error => {
          console.error('Error fetching products:', error);
          showError(`Failed to load products: ${error.message}`);
        })
        .finally(() => {
          productSelect.parentElement.classList.remove('is-loading');
        });
      }

      // Fetch product details - FIXED VERSION
      function loadProductDetails(row, purchaseId) {
        const stockInput = row.querySelector('.stock-input');
        const rateInput = row.querySelector('.rate-input');
        const qtyInput = row.querySelector('.qty-input');
        rateInput.parentElement.classList.add('is-loading');

        fetch(`/ajax/get-product-details/?purchase_id=${purchaseId}`, {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => {
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          return response.json();
        })
        .then(data => {
          if (data.error) {
            showError(data.error);
            return;
          }
          rateInput.value = parseFloat(data.sale_rate || data.product_rate || 0).toFixed(2);
          stockInput.value = data.quantity || 0;
          qtyInput.max = data.quantity || 0;
          calculateRowTotal(row);
          calculateTotals();
        })
        .catch(error => {
          console.error('Error fetching product details:', error);
          // Fallback: try to get data from option attributes
          const productSelect = row.querySelector('.product-select');
          const selectedOption = productSelect.options[productSelect.selectedIndex];
          if (selectedOption) {
            const stock = selectedOption.getAttribute('data-stock') || 0;
            const rate = selectedOption.getAttribute('data-rate') || 0;
            rateInput.value = parseFloat(rate).toFixed(2);
            stockInput.value = stock;
            qtyInput.max = stock;
            calculateRowTotal(row);
            calculateTotals();
          } else {
            showError(`Failed to load product details: ${error.message}`);
          }
        })
        .finally(() => {
          rateInput.parentElement.classList.remove('is-loading');
        });
      }

      // Add new row
      document.getElementById('addRowBtn').addEventListener('click', function() {
        const tbody = document.getElementById('productRows');
        const totalForms = document.getElementById('items-TOTAL_FORMS');
        const index = parseInt(totalForms.value);

        const newRow = document.createElement('tr');
        newRow.setAttribute('data-index', index);
        newRow.innerHTML = `
          <td>
            <select class="form-select form-select-sm category-select" name="items-${index}-category">
              <option value="">Select Category</option>
              {% for category in categories %}
                <option value="{{ category.id }}">{{ category.name }}</option>
              {% endfor %}
            </select>
            <span class="spinner-border spinner-border-sm spinner" role="status"></span>
          </td>
          <td>
            <select class="form-select form-select-sm subcategory-select" name="items-${index}-subcategory" disabled>
              <option value="">Select Subcategory</option>
            </select>
            <span class="spinner-border spinner-border-sm spinner" role="status"></span>
          </td>
          <td>
            <select class="form-select form-select-sm product-select" name="items-${index}-product" disabled>
              <option value="">Select Product</option>
            </select>
            <span class="spinner-border spinner-border-sm spinner" role="status"></span>
          </td>
          <td>
            <input type="text" class="form-control form-control-sm stock-input" readonly value="0">
          </td>
          <td>
            <input type="number" class="form-control form-control-sm qty-input" name="items-${index}-quantity" min="1" value="1">
          </td>
          <td>
            <input type="text" class="form-control form-control-sm rate-input" name="items-${index}-price" readonly>
          </td>
          <td>
            <input type="text" class="form-control form-control-sm total-input" readonly value="0.00">
          </td>
          <td class="text-center">
            <button type="button" class="btn btn-remove">
              <i class="fas fa-times-circle"></i>
            </button>
          </td>
        `;
        tbody.appendChild(newRow);
        totalForms.value = index + 1;

        initRowEvents(newRow);
      });

      // Initialize events for existing rows
      document.querySelectorAll('#productRows tr').forEach(row => initRowEvents(row));

      // Initialize events for a row
      function initRowEvents(row) {
        const categorySelect = row.querySelector('.category-select');
        const subcategorySelect = row.querySelector('.subcategory-select');
        const productSelect = row.querySelector('.product-select');
        const stockInput = row.querySelector('.stock-input');
        const qtyInput = row.querySelector('.qty-input');
        const rateInput = row.querySelector('.rate-input');
        const totalInput = row.querySelector('.total-input');
        const removeBtn = row.querySelector('.btn-remove');

        // Category change event
        categorySelect.addEventListener('change', function() {
          const categoryId = this.value;
          if (categoryId) {
            loadSubcategories(row, categoryId);
          }
          subcategorySelect.value = '';
          productSelect.innerHTML = '<option value="">Select Product</option>';
          productSelect.disabled = true;
          stockInput.value = '0';
          rateInput.value = '';
          totalInput.value = '0.00';
          calculateTotals();
        });

        // Subcategory change event
        subcategorySelect.addEventListener('change', function() {
          const subcategoryId = this.value;
          if (subcategoryId) {
            loadProducts(row, subcategoryId);
          }
          productSelect.value = '';
          stockInput.value = '0';
          rateInput.value = '';
          totalInput.value = '0.00';
          calculateTotals();
        });

        // Product change event
        productSelect.addEventListener('change', function() {
          const purchaseId = this.value;
          if (purchaseId) {
            loadProductDetails(row, purchaseId);
          } else {
            stockInput.value = '0';
            rateInput.value = '';
            totalInput.value = '0.00';
            calculateTotals();
          }
        });

        // Quantity change event
        qtyInput.addEventListener('input', function() {
          const maxStock = parseInt(qtyInput.max) || 0;
          if (this.value > maxStock) {
            showError(`Only ${maxStock} items available in stock!`);
            this.value = maxStock;
            this.classList.add('is-invalid');
          } else {
            this.classList.remove('is-invalid');
          }
          calculateRowTotal(row);
          calculateTotals();
        });

        // Remove row event
        removeBtn.addEventListener('click', function() {
          if (document.querySelectorAll('#productRows tr').length > 1) {
            row.remove();
            updateFormIndices();
            calculateTotals();
          } else {
            showError('You need at least one product in the invoice.');
          }
        });
      }

      // Update form indices after adding/removing rows
      function updateFormIndices() {
        const rows = document.querySelectorAll('#productRows tr');
        const totalForms = document.getElementById('items-TOTAL_FORMS');
        totalForms.value = rows.length;

        rows.forEach((row, index) => {
          row.setAttribute('data-index', index);
          row.querySelector('.category-select').name = `items-${index}-category`;
          row.querySelector('.subcategory-select').name = `items-${index}-subcategory`;
          row.querySelector('.product-select').name = `items-${index}-product`;
          row.querySelector('.stock-input').name = `items-${index}-stock`;
          row.querySelector('.qty-input').name = `items-${index}-quantity`;
          row.querySelector('.rate-input').name = `items-${index}-price`;
        });
      }

      // Calculate row total
      function calculateRowTotal(row) {
        const qtyInput = row.querySelector('.qty-input');
        const rateInput = row.querySelector('.rate-input');
        const totalInput = row.querySelector('.total-input');

        const qty = parseFloat(qtyInput.value) || 0;
        const rate = parseFloat(rateInput.value) || 0;

        const total = rate * qty;
        totalInput.value = total.toFixed(2);
      }

      // Calculate all totals
      function calculateTotals() {
        let subtotal = 0;

        document.querySelectorAll('.total-input').forEach(input => {
          subtotal += parseFloat(input.value) || 0;
        });

        const discountAmt = parseFloat(document.getElementById('discountAmount').value) || 0;

        const grandTotal = subtotal - discountAmt;

        document.getElementById('subtotalValue').textContent = `₹${subtotal.toFixed(2)}`;
        document.getElementById('discountValue').textContent = `-₹${discountAmt.toFixed(2)}`;
        document.getElementById('grandTotal').textContent = `₹${grandTotal.toFixed(2)}`;
      }

      // Populate modal with invoice details
      function populateModal(data) {
        redirectUrl = data.redirect_url || '';
        document.getElementById('modalBillNumber').textContent = data.bill_number || 'N/A';
        document.getElementById('modalCustomerName').textContent = document.querySelector('input[name="customer_name"]').value || 'N/A';
        document.getElementById('modalCustomerPhone').textContent = document.querySelector('input[name="customer_phone"]').value || 'N/A';
        document.getElementById('modalCustomerAddress').textContent = document.querySelector('textarea[name="customer_address"]').value || 'N/A';

        const modalProductRows = document.getElementById('modalProductRows');
        modalProductRows.innerHTML = '';
        document.querySelectorAll('#productRows tr').forEach(row => {
          const productSelect = row.querySelector('.product-select');
          const qtyInput = row.querySelector('.qty-input');
          const rateInput = row.querySelector('.rate-input');
          const totalInput = row.querySelector('.total-input');

          if (productSelect.value) {
            const rowHtml = `
              <tr>
                <td>${productSelect.options[productSelect.selectedIndex]?.text || 'N/A'}</td>
                <td>${qtyInput.value || '0'}</td>
                <td>₹${parseFloat(rateInput.value || 0).toFixed(2)}</td>
                <td>₹${parseFloat(totalInput.value || 0).toFixed(2)}</td>
              </tr>
            `;
            modalProductRows.insertAdjacentHTML('beforeend', rowHtml);
          }
        });

        document.getElementById('modalSubtotal').textContent = document.getElementById('subtotalValue').textContent;
        document.getElementById('modalDiscount').textContent = document.getElementById('discountValue').textContent;
        document.getElementById('modalGrandTotal').textContent = document.getElementById('grandTotal').textContent;
      }

      // Add event listeners to summary inputs
      document.getElementById('discountAmount').addEventListener('input', function() {
        if (this.value < 0) {
          showError('Discount cannot be negative');
          this.value = 0;
          this.classList.add('is-invalid');
        } else {
          this.classList.remove('is-invalid');
        }
        calculateTotals();
      });

      // Form submission for Create Invoice
      document.getElementById('createInvoiceBtn').addEventListener('click', function(e) {
        e.preventDefault();
        submitForm('create');
      });

      // Generic form submission function
      function submitForm(action) {
        hideError();

        const customerName = document.querySelector('input[name="customer_name"]').value.trim();
        const customerPhone = document.querySelector('input[name="customer_phone"]').value.trim();

        if (!customerName || !customerPhone) {
          showError('Please fill in customer name and phone');
          return;
        }

        // Validate phone number (10 digits)
        const phoneDigits = customerPhone.replace(/\D/g, '');
        if (phoneDigits.length !== 10) {
          showError('Phone number must be exactly 10 digits');
          return;
        }

        let hasProducts = false;
        let invalidRows = false;
        document.querySelectorAll('#productRows tr').forEach(row => {
          const productSelect = row.querySelector('.product-select');
          const qtyInput = row.querySelector('.qty-input');
          const rateInput = row.querySelector('.rate-input');
          if (productSelect.value) {
            hasProducts = true;
            if (!qtyInput.value || parseFloat(qtyInput.value) <= 0 || !rateInput.value) {
              invalidRows = true;
            }
          }
        });

        if (!hasProducts) {
          showError('Please add at least one product to the invoice');
          return;
        }

        if (invalidRows) {
          showError('Please ensure all selected products have valid quantity and rate');
          return;
        }

        const formData = new FormData(document.getElementById('invoiceForm'));
        formData.append('action', action);
        
        const submitButton = document.getElementById('createInvoiceBtn');
        const actionText = 'Creating Invoice';
        
        submitButton.disabled = true;
        submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status"></span> ${actionText}...`;

        fetch(document.getElementById('invoiceForm').action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCsrfToken()
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            populateModal(data);
            const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
            modal.show();

            document.getElementById('printInvoiceBtn').onclick = function() {
              const modalContent = document.querySelector('.modal-content').outerHTML;
              const printWindow = window.open('', '_blank');
              printWindow.document.write(`
                <html>
                  <head>
                    <title>Print Invoice</title>
                    <style>
                      body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; }
                      .modal-content { border: none; padding: 20px; }
                      .modal-table { width: 100%; border-collapse: collapse; }
                      .modal-table th, .modal-table td { border: 1px solid #e2e8f0; padding: 10px; }
                      .modal-table th { background-color: #f8fafc; font-weight: 600; }
                      .no-print { display: none; }
                    </style>
                  </head>
                  <body>
                    ${modalContent}
                  </body>
                </html>
              `);
              printWindow.document.close();
              printWindow.print();
              if (redirectUrl) {
                setTimeout(() => { window.location.href = redirectUrl; }, 500);
              } else {
                showError('Redirect URL not found. Invoice saved, but cannot redirect.');
              }
            };
          } else {
            showError(data.error || 'Unknown error occurred');
          }
        })
        .catch(error => {
          console.error(`${actionText} error:`, error);
          showError(`Failed to ${actionText.toLowerCase()}: ${error.message}`);
        })
        .finally(() => {
          submitButton.disabled = false;
          submitButton.innerHTML = '<i class="fas fa-check-circle me-2"></i>Create Invoice';
        });
      }

      // Cancel button
      document.getElementById('cancelBtn').addEventListener('click', function() {
        if (confirm('Are you sure you want to cancel? Unsaved changes will be lost.')) {
          window.location.href = '/'; // Adjust to your desired cancel URL
        }
      });

      // Print button (preview without saving)
      document.getElementById('printBtn').addEventListener('click', function() {
        alert('This is a basic preview. After creating the invoice, you can access a professional print version with enhanced formatting from the invoice details page.');
        const modalContent = document.querySelector('.modal-content').outerHTML;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
          <html>
            <head>
              <title>Print Invoice Preview</title>
              <style>
                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; }
                .modal-content { border: none; padding: 20px; }
                .modal-table { width: 100%; border-collapse: collapse; }
                .modal-table th, .modal-table td { border: 1px solid #e2e8f0; padding: 10px; }
                .modal-table th { background-color: #f8fafc; font-weight: 600; }
                .no-print { display: none; }
              </style>
            </head>
            <body>
              ${modalContent}
            </body>
          </html>
        `);
        printWindow.document.close();
        printWindow.print();
      });

      // Initial calculation
      calculateTotals();
    });
  </script>
</body>
</html>